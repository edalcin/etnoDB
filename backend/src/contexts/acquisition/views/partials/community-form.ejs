<div class="card border-l-4 border-forest-500" x-data="{ plantCount: 1 }">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-gray-900">Comunidade <%= communityIndex + 1 %></h3>
    <% if (communityIndex > 0) { %>
      <button
        type="button"
        class="text-red-600 hover:text-red-800 text-sm"
        @click="$el.closest('.card').remove()"
      >
        Remover Comunidade
      </button>
    <% } %>
  </div>

  <div class="space-y-4">
    <!-- Community Name -->
    <div>
      <label class="form-label" for="comunidades[<%= communityIndex %>][nome]">
        Nome da Comunidade <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="comunidades[<%= communityIndex %>][nome]"
        name="comunidades[<%= communityIndex %>][nome]"
        class="form-input"
        value="<%= community?.nome || '' %>"
        required
        maxlength="200"
      >
    </div>

    <!-- Community Type -->
    <div>
      <label class="form-label" for="comunidades[<%= communityIndex %>][tipo]">
        Tipo de Comunidade
        <span class="text-xs text-gray-500">(Conforme o Decreto nº 11.481, de 6 de abril de 2023)</span>
      </label>
      <select
        id="comunidades[<%= communityIndex %>][tipo]"
        name="comunidades[<%= communityIndex %>][tipo]"
        class="form-input"
      >
        <option value="">Selecione o tipo...</option>
        <option value="Andirobeiros" <%= community?.tipo === 'Andirobeiros' ? 'selected' : '' %>>Andirobeiros</option>
        <option value="Apanhadores de flores sempre-vivas" <%= community?.tipo === 'Apanhadores de flores sempre-vivas' ? 'selected' : '' %>>Apanhadores de flores sempre-vivas</option>
        <option value="Benzedeiros" <%= community?.tipo === 'Benzedeiros' ? 'selected' : '' %>>Benzedeiros</option>
        <option value="Caatingueiros" <%= community?.tipo === 'Caatingueiros' ? 'selected' : '' %>>Caatingueiros</option>
        <option value="Caboclos" <%= community?.tipo === 'Caboclos' ? 'selected' : '' %>>Caboclos</option>
        <option value="Caiçaras" <%= community?.tipo === 'Caiçaras' ? 'selected' : '' %>>Caiçaras</option>
        <option value="Catadores de mangaba" <%= community?.tipo === 'Catadores de mangaba' ? 'selected' : '' %>>Catadores de mangaba</option>
        <option value="Cipozeiros" <%= community?.tipo === 'Cipozeiros' ? 'selected' : '' %>>Cipozeiros</option>
        <option value="Comunidades de fundos e fechos de pasto" <%= community?.tipo === 'Comunidades de fundos e fechos de pasto' ? 'selected' : '' %>>Comunidades de fundos e fechos de pasto</option>
        <option value="Comunidades quilombolas" <%= community?.tipo === 'Comunidades quilombolas' ? 'selected' : '' %>>Comunidades quilombolas</option>
        <option value="Extrativistas" <%= community?.tipo === 'Extrativistas' ? 'selected' : '' %>>Extrativistas</option>
        <option value="Extrativistas costeiros e marinhos" <%= community?.tipo === 'Extrativistas costeiros e marinhos' ? 'selected' : '' %>>Extrativistas costeiros e marinhos</option>
        <option value="Faxinalenses" <%= community?.tipo === 'Faxinalenses' ? 'selected' : '' %>>Faxinalenses</option>
        <option value="Geraizeiros" <%= community?.tipo === 'Geraizeiros' ? 'selected' : '' %>>Geraizeiros</option>
        <option value="Ilhéus" <%= community?.tipo === 'Ilhéus' ? 'selected' : '' %>>Ilhéus</option>
        <option value="Juventude de povos e comunidades tradicionais" <%= community?.tipo === 'Juventude de povos e comunidades tradicionais' ? 'selected' : '' %>>Juventude de povos e comunidades tradicionais</option>
        <option value="Morroquianos" <%= community?.tipo === 'Morroquianos' ? 'selected' : '' %>>Morroquianos</option>
        <option value="Pantaneiros" <%= community?.tipo === 'Pantaneiros' ? 'selected' : '' %>>Pantaneiros</option>
        <option value="Pescadores artesanais" <%= community?.tipo === 'Pescadores artesanais' ? 'selected' : '' %>>Pescadores artesanais</option>
        <option value="Povo pomerano" <%= community?.tipo === 'Povo pomerano' ? 'selected' : '' %>>Povo pomerano</option>
        <option value="Povos ciganos" <%= community?.tipo === 'Povos ciganos' ? 'selected' : '' %>>Povos ciganos</option>
        <option value="Povos e comunidades de terreiro / matriz africana" <%= community?.tipo === 'Povos e comunidades de terreiro / matriz africana' ? 'selected' : '' %>>Povos e comunidades de terreiro / matriz africana</option>
        <option value="Povos indígenas" <%= community?.tipo === 'Povos indígenas' ? 'selected' : '' %>>Povos indígenas</option>
        <option value="Quebradeiras de coco babaçu" <%= community?.tipo === 'Quebradeiras de coco babaçu' ? 'selected' : '' %>>Quebradeiras de coco babaçu</option>
        <option value="Raizeiros" <%= community?.tipo === 'Raizeiros' ? 'selected' : '' %>>Raizeiros</option>
        <option value="Retireiros do Araguaia" <%= community?.tipo === 'Retireiros do Araguaia' ? 'selected' : '' %>>Retireiros do Araguaia</option>
        <option value="Ribeirinhos" <%= community?.tipo === 'Ribeirinhos' ? 'selected' : '' %>>Ribeirinhos</option>
        <option value="Vazanteiros" <%= community?.tipo === 'Vazanteiros' ? 'selected' : '' %>>Vazanteiros</option>
        <option value="Veredeiros" <%= community?.tipo === 'Veredeiros' ? 'selected' : '' %>>Veredeiros</option>
      </select>
    </div>

    <!-- State -->
    <div>
      <label class="form-label" for="comunidades[<%= communityIndex %>][estado]">
        Estado <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="comunidades[<%= communityIndex %>][estado]"
        name="comunidades[<%= communityIndex %>][estado]"
        class="form-input"
        value="<%= community?.estado || '' %>"
        placeholder="São Paulo"
        required
        maxlength="100"
      >
    </div>

    <!-- Municipality -->
    <div>
      <label class="form-label" for="comunidades[<%= communityIndex %>][municipio]">
        Município
      </label>
      <input
        type="text"
        id="comunidades[<%= communityIndex %>][municipio]"
        name="comunidades[<%= communityIndex %>][municipio]"
        class="form-input"
        value="<%= community?.municipio || '' %>"
        maxlength="100"
      >
    </div>

    <!-- Location (optional) -->
    <div>
      <label class="form-label" for="comunidades[<%= communityIndex %>][local]">
        Local (detalhamento)
      </label>
      <input
        type="text"
        id="comunidades[<%= communityIndex %>][local]"
        name="comunidades[<%= communityIndex %>][local]"
        class="form-input"
        value="<%= community?.local || '' %>"
        placeholder="limite sul do Núcleo Picinguaba"
        maxlength="500"
      >
    </div>

    <!-- Economic Activities (comma-separated) -->
    <div>
      <label class="form-label" for="comunidades[<%= communityIndex %>][atividadesEconomicas]">
        Atividades Econômicas
        <span class="text-gray-500 text-xs">(separadas por vírgula)</span>
      </label>
      <input
        type="text"
        id="comunidades[<%= communityIndex %>][atividadesEconomicas]"
        name="comunidades[<%= communityIndex %>][atividadesEconomicas]"
        class="form-input"
        value="<%= community?.atividadesEconomicas?.join(', ') || '' %>"
        placeholder="pesca, agricultura, turismo"
      >
    </div>

    <!-- Observations -->
    <div>
      <label class="form-label" for="comunidades[<%= communityIndex %>][observacoes]">
        Observações
      </label>
      <textarea
        id="comunidades[<%= communityIndex %>][observacoes]"
        name="comunidades[<%= communityIndex %>][observacoes]"
        class="form-input"
        rows="2"
        maxlength="2000"
      ><%= community?.observacoes || '' %></textarea>
    </div>

    <!-- Plants Section -->
    <div class="border-t pt-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-md font-semibold text-gray-800">Plantas</h4>
        <button
          type="button"
          class="btn btn-secondary btn-sm text-sm px-3 py-1"
          @click="plantCount++"
          hx-post="/plant/add/<%= communityIndex %>"
          hx-target="#plants-container-<%= communityIndex %>"
          hx-swap="beforeend"
          hx-vals='js:{"plantIndex": plantCount}'
        >
          + Adicionar Planta
        </button>
      </div>

      <div id="plants-container-<%= communityIndex %>" class="space-y-3">
        <!-- Initial plant form -->
        <div class="bg-gray-50 p-4 rounded border">
          <div class="flex items-center justify-between mb-3">
            <h5 class="text-sm font-semibold text-gray-700">Planta 1</h5>
          </div>

          <div class="space-y-3">
            <!-- Scientific Name (comma-separated) -->
            <div>
              <label class="form-label text-sm" for="comunidades[<%= communityIndex %>][plantas][0][nomeCientifico]">
                Nome Científico
                <span class="text-gray-500 text-xs">(separados por vírgula)</span>
              </label>
              <input
                type="text"
                id="comunidades[<%= communityIndex %>][plantas][0][nomeCientifico]"
                name="comunidades[<%= communityIndex %>][plantas][0][nomeCientifico]"
                class="form-input text-sm"
                placeholder="Foeniculum vulgare, Bidens pilosa L."
              >
            </div>

            <!-- Vernacular Name (comma-separated) -->
            <div>
              <label class="form-label text-sm" for="comunidades[<%= communityIndex %>][plantas][0][nomeVernacular]">
                Nome Vernacular
                <span class="text-gray-500 text-xs">(separados por vírgula)</span>
              </label>
              <input
                type="text"
                id="comunidades[<%= communityIndex %>][plantas][0][nomeVernacular]"
                name="comunidades[<%= communityIndex %>][plantas][0][nomeVernacular]"
                class="form-input text-sm"
                placeholder="erva-doce, picão, jiçara"
              >
            </div>

            <p class="text-xs text-gray-600 italic">* Pelo menos um nome (científico ou vernacular) é obrigatório</p>

            <!-- Type of Use (comma-separated) -->
            <div>
              <label class="form-label text-sm" for="comunidades[<%= communityIndex %>][plantas][0][tipoUso]">
                Tipo de Uso
                <span class="text-gray-500 text-xs">(separados por vírgula)</span>
              </label>
              <input
                type="text"
                id="comunidades[<%= communityIndex %>][plantas][0][tipoUso]"
                name="comunidades[<%= communityIndex %>][plantas][0][tipoUso]"
                class="form-input text-sm"
                placeholder="medicinal, alimentício, artesanato"
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
